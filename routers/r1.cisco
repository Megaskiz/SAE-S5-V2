! Site 1, Router 1
!
enable
config terminal
!
hostname r1
!
ipv6 unicast-routing
!
! IPsec
crypto isakmp policy 4  
 authentication pre-share
exit
!
crypto isakmp key xxxxxx1234 address 10.0.10.1 
crypto isakmp key xxxxxx1234 address 1.0.0.2
!
crypto ipsec transform-set encrypt-des esp-des
!
crypto map combined 20 ipsec-isakmp  
 set peer 10.0.10.1 
 set transform-set encrypt-des  
 match address 106
exit
!
crypto map combined 30 ipsec-isakmp  
 set peer 1.0.0.2
 set transform-set encrypt-des  
 match address 105
exit
!
! To switch top
interface FastEthernet0/0
 no shutdown
exit
!
! Chef
interface FastEthernet0/0.20
 encapsulation dot1q 20
 ip address 192.168.1.1 255.255.255.128
 ip ospf 2 area 2
 ipv6 enable
 ipv6 address 2000:0:0:10::1/64
 ipv6 ospf 2 area 2
exit
!
! Employee
interface FastEthernet0/0.30
 encapsulation dot1q 30
 ip address 192.168.1.129 255.255.255.128
 ip ospf 2 area 2
 ipv6 enable
 ipv6 address 2000:0:0:11::1/64
 ipv6 ospf 2 area 2
exit
!
! To r4
interface FastEthernet0/1
 no shutdown
 ip address 10.0.70.1 255.255.255.252
 ip ospf 2 area 2
 ipv6 enable
 ipv6 address fd00:70::1/64
 ipv6 ospf 2 area 2
 crypto map combined
exit
!
! MPLS
interface Loopback0
 ip address 1.1.1.1 255.255.255.255
 ip ospf 2 area 2
exit
!
ipv6 router ospf 2
 router-id 2.2.2.1
exit
!
! Define traffic for NAT
ip nat inside source route-map nonat interface FastEthernet0/1 overload
!
! Access control list (ACL) that shows traffic to encrypt over the tunnel.
access-list 105 permit ip 192.168.1.0 0.0.0.255 192.168.2.0 0.0.0.255  
access-list 106 permit ip 192.168.1.0 0.0.0.255 192.168.0.0 0.0.0.255
!
! ACL to avoid the traffic through NAT over the tunnel. 
access-list 150 deny ip 192.168.1.0 0.0.0.255 192.168.2.0 0.0.0.255  
access-list 150 deny ip 192.168.1.0 0.0.0.255 192.168.0.0 0.0.0.255
!
! ACL to perform NAT on the traffic that does not go over the tunnel.
access-list 150 permit ip 192.168.1.0 0.0.0.255 any
!
! Do not perform NAT on the IPSec traffic.
route-map nonat permit 10  
  match ip address 150
exit
!
exit
exit
!
